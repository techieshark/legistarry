MESA_IDS = ["1924", "1925", "1926", "1927", "1928", "1235", "1237", "1245", "1246", "1250", "1251", "1252", "1253", "1255", "1256", "1265", "1269", "1270", "1272", "1277", "1280", "1283", "1285", "1287", "1290", "1292", "1295", "1297", "1298", "1300", "1301", "1302", "1303", "1304", "1305", "1306", "1311", "1312", "1313", "1314", "1315", "1317", "1318", "1321", "1322", "1323", "1325", "1326", "1327", "1328", "1329", "1330", "1331", "1332", "1333", "1334", "1335", "1339", "1341", "1342", "1345", "1348", "1350", "1352", "1354", "1355", "1357", "1359", "1360", "1362", "1363", "1372", "1380", "1389", "1391", "1393", "1396", "1398", "1405", "1406", "1407", "1409", "1410", "1413", "1414", "1416", "1417", "1420", "1422", "1423", "1425", "1426", "1430", "1431", "1433", "1437", "1438", "1439", "1440", "1441", "1443", "1445", "1447", "1448", "1449", "1451", "1452", "1456", "1457", "1459", "1460", "1461", "1462", "1464", "1472", "1473", "1474", "1475", "1476", "1477", "1478", "1479", "1480", "1482", "1483", "1484", "1485", "1486", "1488", "1490", "1491", "1492", "1493", "1496", "1497", "1498", "1499", "1500", "1502", "1503", "1506", "1507", "1508", "1509", "1510", "1511", "1512", "1513", "1514", "1515", "1516", "1517", "1518", "1519", "1520", "1521", "1522", "1524", "1525", "1526", "1529", "1530", "1533", "1535", "1536", "1537", "1538", "1539", "1540", "1541", "1543", "1546", "1547", "1548", "1549", "1550", "1553", "1554", "1560", "1561", "1562", "1564", "1565", "1566", "1567", "1569", "1570", "1571", "1572", "1573", "1574", "1575", "1576", "1577", "1578", "1579", "1580", "1582", "1583", "1584", "1586", "1587", "1589", "1591", "1592", "1593", "1595", "1598", "1599", "1612", "1615", "1616", "1617", "1618", "1620", "1621", "1622", "1623", "1624", "1625", "1626", "1627", "1628", "1629", "1630", "1632", "1633", "1634", "1635", "1636", "1637", "1638", "1639", "1641", "1643", "1644", "1645", "1646", "1647", "1648", "1649", "1651", "1652", "1653", "1654", "1655", "1656", "1657", "1658", "1659", "1660", "1663", "1664", "1665", "1666", "1667", "1668", "1669", "1670", "1671", "1672", "1673", "1674", "1675", "1676", "1678", "1679", "1680", "1681", "1682", "1683", "1684", "1685", "1687", "1689", "1690", "1691", "1692", "1693", "1694", "1695", "1696", "1697", "1698", "1699", "1702", "1703", "1704", "1705", "1706", "1707", "1708", "1709", "1710", "1712", "1713", "1714", "1715", "1717", "1718", "1719", "1722", "1723", "1724", "1725", "1726", "1727", "1728", "1729", "1730", "1731", "1733", "1734", "1735", "1736", "1738", "1739", "1740", "1741", "1742", "1743", "1744", "1745", "1746", "1747", "1748", "1749", "1750", "1751", "1752", "1753", "1754", "1755", "1757", "1758", "1759", "1760", "1761", "1762", "1763", "1764", "1765", "1766", "1767", "1768", "1769", "1770", "1771", "1772", "1773", "1774", "1775", "1776", "1777", "1778", "1779", "1780", "1781", "1782", "1785", "1786", "1787", "1788", "1789", "1790", "1791", "1796", "1797", "1798", "1799", "1801", "1802", "1803", "1804", "1805", "1806", "1807", "1808", "1809", "1810", "1811", "1812", "1813", "1814", "1816", "1818", "1820", "1821", "1822", "1823", "1824", "1825", "1826", "1827", "1828", "1829", "1830", "1831", "1832", "1833", "1836", "1837", "1838", "1839", "1840", "1842", "1843", "1844", "1845", "1846", "1847", "1848", "1850", "1851", "1852", "1853", "1854", "1856", "1857", "1858", "1859", "1860", "1862", "1863", "1864", "1867", "1868", "1869", "1870", "1871", "1872", "1873", "1874", "1875", "1876", "1877", "1878", "1879", "1880", "1881", "1882", "1883", "1884", "1885", "1886", "1887", "1890", "1891", "1892", "1894", "1895", "1897", "1898", "1899", "1901", "1902", "1904", "1905", "1907", "1908", "1909", "1911", "1912", "1913", "1914", "1915", "1918", "1920", "1921", "1922", "1923"]

task :populate_event_items do
  require './db'

  require 'active_support/core_ext/string/inflections'
  require 'active_support/notifications'
  require 'faraday'
  require 'faraday_middleware'
  require 'logger'

  Log = Logger.new(STDOUT)

  # fucking legistar - their api is broken
  connection = Faraday.new(url: 'http://webapi.legistar.com') do |conn|
    conn.headers['Accept'] = 'text/json'
    conn.request :instrumentation
    conn.response :json
    conn.adapter Faraday.default_adapter
  end

  MESA_IDS.each do |event_id|
    Log.info DB[:event_items].count

    begin
      response = connection.get("/v1/mesa/Events/#{event_id}/EventItems")
      raise unless response.status == 200
      event_items = response.body

      event_items.each do |item|
        attrs = item.reduce({}){ |result, (k,v)|
          result[k.underscore.sub('event_item_', '')] = v
          result
        }

        attrs['source_id'] = attrs.delete('id')

        DB[:event_items].insert(attrs)
      end

      sleep 1
    rescue => e
      Log.error("Event ID: #{event_id}")
      Log.error(e)
    end
  end
end
